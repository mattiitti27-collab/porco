<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTINI SYSTEM | DeepCharts Ultimate Fixed</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#010101', /* Nero Assoluto */
                        panel: '#0A0A0E',
                        border: '#1C1C22',
                        primary: '#2DD4BF', // Teal Neon
                        accent: '#38BDF8',  // Sky Blue
                        success: '#34D399', // Emerald
                        gold: '#FBBF24',    // Amber Gold
                        danger: '#FB7185',  // Rose
                        push: '#A78BFA',    // Violet
                        textMain: '#F3F4F6',
                        textDim: '#64748B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['"Space Mono"', 'monospace']
                    },
                    boxShadow: {
                        'neon-blue': '0 0 10px rgba(56, 189, 248, 0.4), 0 0 20px rgba(56, 189, 248, 0.2)',
                        'neon-gold': '0 0 10px rgba(251, 191, 36, 0.4), 0 0 20px rgba(251, 191, 36, 0.2)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.5)'
                    },
                    animation: {
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        pulseGlow: {
                            '0%, 100%': { opacity: 1, filter: 'brightness(1)' },
                            '50%': { opacity: 0.8, filter: 'brightness(1.2)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #010101;
            color: #E5E5E5; 
            overflow: hidden;
            /* Sfondo atmosferico complesso */
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.08), transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(167, 139, 250, 0.08), transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
        }

        /* GRIGLIA TECNICA DI SFONDO */
        .tech-grid {
            position: absolute; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 30%, transparent 90%);
        }

        /* EFFETTO VETRO PREMIUM */
        .glass-panel {
            background: rgba(10, 10, 14, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* Bordi luminosi al passaggio del mouse */
        .glass-panel::after {
            content: ''; position: absolute; inset: 0; border-radius: 16px; padding: 1px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .glass-panel:hover {
            background: rgba(15, 15, 20, 0.75);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transform: translateY(-2px);
        }

        /* TIPOGRAFIA DATI */
        .label-tech {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #64748B;
            font-weight: 700;
        }

        /* INPUTS */
        .tech-input {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            color: white;
            font-family: 'Space Mono', monospace;
            transition: all 0.2s;
        }
        .tech-input:focus {
            outline: none;
            border-color: #38BDF8;
            background: rgba(56, 189, 248, 0.05);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
        }

        /* CUSTOM CHECKBOX */
        .cyber-check input:checked + div {
            background: #38BDF8;
            border-color: #38BDF8;
            box-shadow: 0 0 12px rgba(56, 189, 248, 0.6);
        }
        
        /* SLIDER */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 6px; 
            background: #2DD4BF; border: 1px solid #fff; border-radius: 2px;
            cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(45, 212, 191, 0.6);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #1C1C22; border-radius: 2px;
        }

        /* MOOD BUTTONS - FIXED LAYOUT */
        .mood-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px; /* Spazio aumentato per evitare tagli */
            padding: 4px; /* Padding interno per l'ombra/glow */
        }
        .mood-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible; /* Importante per non tagliare il glow */
        }
        .mood-btn.active {
            transform: scale(1.1);
            z-index: 10;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 md:p-6 gap-5 selection:bg-primary selection:text-black">

    <div class="tech-grid"></div>

    <header class="flex justify-between items-end pb-3 border-b border-white/5 relative z-20 pt-4"> 
        <div class="flex items-center gap-5">
            <div class="relative w-12 h-12 rounded-xl bg-black border border-white/10 flex items-center justify-center shadow-2xl group overflow-hidden mt-2 animate-float"> 
                <div class="absolute inset-0 bg-primary/10 blur-xl group-hover:bg-primary/20 transition duration-500"></div>
                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-50"></div>
                <i class="fa-solid fa-chart-line text-primary text-xl relative z-10 drop-shadow-[0_0_8px_rgba(45,212,191,0.8)]"></i>
            </div>
            
            <div class="mt-2"> 
                <h1 class="text-4xl font-black tracking-tighter text-white leading-none flex items-center gap-1">
                    INTINI<span class="text-transparent bg-clip-text bg-gradient-to-r from-accent to-primary animate-pulse-glow">SYSTEM</span>
                </h1>
                <div class="flex items-center gap-2 mt-2">
                    <div class="h-0.5 w-8 bg-gradient-to-r from-primary to-transparent rounded-full"></div>
                    <p class="text-[9px] font-mono text-gray-500 uppercase tracking-[0.3em] font-bold">DeepCharts Ultimate v3.0</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-1 bg-black/60 border border-white/10 rounded-xl p-1.5 backdrop-blur-xl shadow-glass">
            <button onclick="changeMonth(-1)" class="w-9 h-9 flex items-center justify-center text-textDim hover:text-white hover:bg-white/10 rounded-lg transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
            <div id="month-display" class="w-40 text-center font-mono font-bold text-sm text-white uppercase tracking-widest"></div>
            <button onclick="changeMonth(1)" class="w-9 h-9 flex items-center justify-center text-textDim hover:text-white hover:bg-white/10 rounded-lg transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
            <div class="w-px h-5 bg-white/10 mx-2"></div>
            <button onclick="setToday()" class="px-4 h-9 text-[10px] font-bold text-black bg-primary hover:bg-white transition rounded-lg uppercase tracking-wide shadow-[0_0_10px_rgba(45,212,191,0.4)]">Today</button>
        </div>
    </header>

    <main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-hidden relative z-10 pt-2">

        <aside class="lg:col-span-3 flex flex-col gap-5 overflow-y-auto pr-2 pb-2 custom-scroll">
            
            <div class="glass-panel p-5">
                <div class="flex justify-between items-center mb-3">
                    <span class="label-tech text-accent"><i class="fa-regular fa-clock mr-2"></i>Target Date</span>
                    <div class="flex gap-1">
                        <span class="w-1 h-1 rounded-full bg-white/20"></span>
                        <span class="w-1 h-1 rounded-full bg-white/20"></span>
                        <span class="w-1 h-1 rounded-full bg-accent animate-pulse"></span>
                    </div>
                </div>
                <div class="flex justify-between items-center bg-black/40 border border-white/5 rounded-xl p-3 shadow-inner">
                    <button onclick="changeDay(-1)" class="w-8 h-8 rounded-lg hover:bg-white/10 text-textDim hover:text-white transition"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="text-center">
                        <div id="day-name" class="text-[9px] text-gray-500 font-bold uppercase tracking-[0.2em] mb-0.5"></div>
                        <div id="day-num" class="text-3xl font-mono font-bold text-white leading-none"></div>
                    </div>
                    <button onclick="changeDay(1)" class="w-8 h-8 rounded-lg hover:bg-white/10 text-textDim hover:text-white transition"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="glass-panel p-6 flex-1 flex flex-col gap-6">
                <div class="flex items-center justify-between border-b border-white/5 pb-3">
                    <span class="label-tech text-white"><i class="fa-solid fa-terminal mr-2 text-primary"></i>Protocol Inputs</span>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="label-tech">Checklist</span>
                        <button onclick="toggleEdit()" class="text-[9px] text-primary hover:text-white transition opacity-60 hover:opacity-100"><i class="fa-solid fa-pen-to-square"></i></button>
                    </div>
                    
                    <div id="habit-editor" class="hidden mb-3 p-2 bg-black/40 border border-white/5 rounded-lg">
                        <div class="flex gap-2 mb-2">
                            <input id="new-habit" class="tech-input w-full p-2 text-xs" placeholder="New habit...">
                            <button onclick="addHabit()" class="text-success font-bold px-3 hover:bg-white/5 rounded-lg bg-black/50">+</button>
                        </div>
                        <div id="editor-list" class="max-h-32 overflow-y-auto space-y-1 custom-scroll"></div>
                    </div>

                    <div id="habit-list" class="space-y-2"></div>
                </div>

                <div class="w-full h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="label-tech block mb-2 text-gold">Income (‚Ç¨)</span>
                            <div class="relative group">
                                <span class="absolute left-3 top-2.5 text-gold/50 text-xs font-mono group-focus-within:text-gold transition">‚Ç¨</span>
                                <input type="number" id="input-money" class="tech-input w-full p-2.5 pl-8 text-gold font-bold text-right text-sm" placeholder="0" oninput="saveData()">
                            </div>
                        </div>
                        <div>
                            <span class="label-tech block mb-2 text-primary">Sleep (h)</span>
                            <div class="relative group">
                                <span class="absolute left-3 top-2.5 text-primary/50 text-xs group-focus-within:text-primary transition"><i class="fa-regular fa-clock"></i></span>
                                <input type="number" id="input-sleep" class="tech-input w-full p-2.5 pl-8 text-primary font-bold text-right text-sm" placeholder="0" oninput="saveData()">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="label-tech text-success">Push Intensity</span>
                            <span id="push-val" class="text-xs font-mono text-black bg-success px-2 rounded font-bold shadow-[0_0_10px_rgba(52,211,153,0.4)]">0</span>
                        </div>
                        <input type="range" id="input-push" min="0" max="10" step="1" class="w-full" oninput="updatePushVal(); saveData()">
                    </div>

                    <div>
                        <span class="label-tech block mb-3 text-white">Mental State</span>
                        <div class="mood-grid">
                            <button onclick="setMood(1)" id="m1" class="mood-btn h-10 rounded-xl bg-white/5 border border-white/5 text-lg grayscale opacity-40 hover:opacity-100 hover:bg-white/10">üíÄ</button>
                            <button onclick="setMood(2)" id="m2" class="mood-btn h-10 rounded-xl bg-white/5 border border-white/5 text-lg grayscale opacity-40 hover:opacity-100 hover:bg-white/10">üëé</button>
                            <button onclick="setMood(3)" id="m3" class="mood-btn h-10 rounded-xl bg-white/5 border border-white/5 text-lg grayscale opacity-40 hover:opacity-100 hover:bg-white/10">üëå</button>
                            <button onclick="setMood(4)" id="m4" class="mood-btn h-10 rounded-xl bg-white/5 border border-white/5 text-lg grayscale opacity-40 hover:opacity-100 hover:bg-white/10">üëç</button>
                            <button onclick="setMood(5)" id="m5" class="mood-btn h-10 rounded-xl bg-white/5 border border-white/5 text-lg grayscale opacity-40 hover:opacity-100 hover:bg-white/10">üî•</button>
                        </div>
                        <input type="hidden" id="input-mood">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-4">
                <textarea id="input-notes" class="w-full bg-transparent text-xs font-mono text-gray-400 border-none focus:outline-none resize-none h-12 placeholder-gray-700 leading-relaxed" placeholder="> System Log: Enter daily notes here..." oninput="saveData()"></textarea>
            </div>
        </aside>

        <section class="lg:col-span-9 flex flex-col gap-6 overflow-y-auto pr-2 pb-4 custom-scroll">
            
            <div class="grid grid-cols-4 gap-5">
                <div class="glass-panel p-6 group cursor-default relative overflow-hidden hover:bg-white/[0.02]">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-accent/10 rounded-full blur-3xl group-hover:bg-accent/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="label-tech text-gray-400">Consistency</span>
                        <i class="fa-solid fa-chart-pie text-accent/40 group-hover:text-accent transition group-hover:scale-110"></i>
                    </div>
                    <div id="kpi-cons" class="text-4xl font-mono font-bold text-white group-hover:text-accent transition-colors relative z-10 drop-shadow-lg">0%</div>
                </div>
                
                <div class="glass-panel p-6 group cursor-default relative overflow-hidden hover:bg-white/[0.02]">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-gold/10 rounded-full blur-3xl group-hover:bg-gold/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="label-tech text-gray-400">Net Income</span>
                        <i class="fa-solid fa-wallet text-gold/40 group-hover:text-gold transition group-hover:scale-110"></i>
                    </div>
                    <div id="kpi-inc" class="text-4xl font-mono font-bold text-white group-hover:text-gold transition-colors relative z-10 drop-shadow-lg">0</div>
                </div>
                
                <div class="glass-panel p-6 group cursor-default relative overflow-hidden hover:bg-white/[0.02]">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-success/10 rounded-full blur-3xl group-hover:bg-success/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="label-tech text-gray-400">Push Avg</span>
                        <i class="fa-solid fa-bolt text-success/40 group-hover:text-success transition group-hover:scale-110"></i>
                    </div>
                    <div id="kpi-push" class="text-4xl font-mono font-bold text-white group-hover:text-success transition-colors relative z-10 drop-shadow-lg">0.0</div>
                </div>
                
                <div class="glass-panel p-6 group cursor-default relative overflow-hidden hover:bg-white/[0.02]">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-push/10 rounded-full blur-3xl group-hover:bg-push/20 transition-all duration-500"></div>
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="label-tech text-gray-400">Streak</span>
                        <i class="fa-solid fa-fire text-push/40 group-hover:text-push transition group-hover:scale-110"></i>
                    </div>
                    <div id="kpi-streak" class="text-4xl font-mono font-bold text-white group-hover:text-push transition-colors relative z-10 drop-shadow-lg">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 min-h-[500px]">
                
                <div class="glass-panel p-6 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <div class="label-tech text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-accent/10 flex items-center justify-center border border-accent/20">
                                <i class="fa-solid fa-layer-group text-accent text-xs"></i>
                            </div>
                            Protocol Adherence
                        </div>
                    </div>
                    <div class="flex-1 w-full relative min-h-[200px]">
                        <canvas id="chartCons"></canvas>
                    </div>
                </div>

                <div class="glass-panel p-6 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <div class="label-tech text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-gold/10 flex items-center justify-center border border-gold/20">
                                <i class="fa-solid fa-euro-sign text-gold text-xs"></i>
                            </div>
                            Income Stream
                        </div>
                    </div>
                    <div class="flex-1 w-full relative min-h-[200px]">
                        <canvas id="chartMoney"></canvas>
                    </div>
                </div>

                <div class="glass-panel p-6 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <div class="label-tech text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center border border-primary/20">
                                <i class="fa-solid fa-moon text-primary text-xs"></i>
                            </div>
                            Sleep Cycles
                        </div>
                    </div>
                    <div class="flex-1 w-full relative min-h-[200px]">
                        <canvas id="chartSleep"></canvas>
                    </div>
                </div>

                <div class="glass-panel p-6 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <div class="label-tech text-white flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-success/10 flex items-center justify-center border border-success/20">
                                <i class="fa-solid fa-heart-pulse text-success text-xs"></i>
                            </div>
                            Bio-Metrics
                        </div>
                        <div class="text-[9px] font-mono text-danger bg-danger/10 px-2 py-1 rounded border border-danger/20">MOOD OVERLAY</div>
                    </div>
                    <div class="flex-1 w-full relative min-h-[200px]">
                        <canvas id="chartPush"></canvas>
                    </div>
                </div>

            </div>

        </section>
    </main>

    <script>
        // --- CONFIGURAZIONE ---
        const DEFAULT_HABITS = [
            "WAKE UP 07:00", 
            "DEEP WORK 4H", 
            "TRAINING", 
            "READING 10 PAGES", 
            "NO SHIT SUGAR", 
            "4H RIPETIZIONI"
        ];
        
        let state = {
            date: new Date(),
            habits: JSON.parse(localStorage.getItem('intiniHabits')) || DEFAULT_HABITS,
            data: JSON.parse(localStorage.getItem('intiniData')) || {},
            charts: {}
        };

        // --- FUNZIONE DATA CORRETTA (LOCAL TIME) ---
        // Risolve il problema del grafico "avanti di un giorno" evitando conversioni UTC
        const getKey = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- INIZIALIZZAZIONE ---
        function init() {
            if (Object.keys(state.data).length === 0) {
                injectDummyData();
            }
            updateDateUI();
            loadData();
        }

        function injectDummyData() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth(); // Mese corrente
            const habits = state.habits;
            
            // Dati dal 1 al 6 del mese corrente
            const dummy = [
                { d: 1, inc: 50, slp: 7.0, push: 6, mood: 3, hCount: 3 },
                { d: 2, inc: 120, slp: 6.5, push: 8, mood: 4, hCount: 4 },
                { d: 3, inc: 0, slp: 8.0, push: 5, mood: 3, hCount: 5 },
                { d: 4, inc: 250, slp: 5.5, push: 9, mood: 5, hCount: 6 },
                { d: 5, inc: 80, slp: 7.5, push: 7, mood: 4, hCount: 5 },
                { d: 6, inc: 0, slp: 7.0, push: 6, mood: 3, hCount: 4 }
            ];

            dummy.forEach(item => {
                // Creiamo la data correttamente usando l'anno e mese CORRENTI
                const date = new Date(currentYear, currentMonth, item.d);
                const key = getKey(date);
                
                const checked = habits.slice(0, item.hCount);
                
                state.data[key] = {
                    checked: checked,
                    money: item.inc,
                    sleep: item.slp,
                    push: item.push,
                    mood: item.mood,
                    notes: "System initialization log..."
                };
            });
            localStorage.setItem('intiniData', JSON.stringify(state.data));
        }

        // --- LOGICA PRINCIPALE ---
        function loadData() {
            const key = getKey(state.date);
            const d = state.data[key] || { checked: [], sleep: '', money: '', notes: '', push: 0, mood: 0 };

            document.getElementById('input-money').value = d.money;
            document.getElementById('input-sleep').value = d.sleep;
            document.getElementById('input-notes').value = d.notes;
            document.getElementById('input-push').value = d.push || 0;
            document.getElementById('push-val').innerText = d.push || 0;
            
            const mood = d.mood || 0;
            document.getElementById('input-mood').value = mood;
            highlightMood(mood);

            renderHabits(d.checked);
            updateCharts(); // Grafici aggiornati
            updateKPIs();
        }

        function saveData() {
            const key = getKey(state.date);
            const checked = [];
            state.habits.forEach((h, i) => { if(document.getElementById(`h-${i}`)?.checked) checked.push(h); });

            state.data[key] = {
                checked,
                money: document.getElementById('input-money').value,
                sleep: document.getElementById('input-sleep').value,
                notes: document.getElementById('input-notes').value,
                push: document.getElementById('input-push').value,
                mood: document.getElementById('input-mood').value
            };
            localStorage.setItem('intiniData', JSON.stringify(state.data));
            updateCharts();
            updateKPIs();
        }

        // --- HABITS ---
        function renderHabits(checked) {
            const list = document.getElementById('habit-list');
            const editor = document.getElementById('editor-list');
            list.innerHTML = ''; editor.innerHTML = '';

            state.habits.forEach((h, i) => {
                const isC = checked.includes(h);
                list.innerHTML += `
                    <label class="cyber-check flex items-center gap-3 cursor-pointer group p-3 rounded-xl bg-white/[0.02] border border-white/5 hover:bg-white/[0.05] hover:border-white/10 transition-all">
                        <div class="relative w-5 h-5 flex-shrink-0">
                            <input type="checkbox" id="h-${i}" class="sr-only" onchange="saveData()" ${isC ? 'checked' : ''}>
                            <div class="w-5 h-5 border border-white/20 rounded-[6px] bg-black/50 transition-all"></div>
                        </div>
                        <span class="text-[10px] font-mono text-textDim group-hover:text-white uppercase tracking-wide transition-colors ${isC ? 'text-accent font-bold shadow-neon' : ''}">${h}</span>
                    </label>
                `;
                editor.innerHTML += `<div class="flex justify-between text-[10px] text-gray-400 border-b border-white/5 py-1.5 font-mono"><span>${h}</span><button onclick="remHabit(${i})" class="text-danger hover:text-white transition">DEL</button></div>`;
            });
        }
        function toggleEdit() { document.getElementById('habit-editor').classList.toggle('hidden'); }
        function addHabit() { const v = document.getElementById('new-habit').value.trim(); if(v){ state.habits.push(v.toUpperCase()); localStorage.setItem('intiniHabits', JSON.stringify(state.habits)); loadData(); document.getElementById('new-habit').value=''; }}
        function remHabit(i) { state.habits.splice(i,1); localStorage.setItem('intiniHabits', JSON.stringify(state.habits)); loadData(); }

        // --- NAVIGAZIONE ---
        function updateDateUI() {
            const d = state.date;
            document.getElementById('month-display').innerText = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('day-name').innerText = d.toLocaleDateString('en-US', { weekday: 'long' });
            document.getElementById('day-num').innerText = d.getDate();
        }
        function changeDay(n) { state.date.setDate(state.date.getDate()+n); updateDateUI(); loadData(); }
        function changeMonth(n) { state.date.setMonth(state.date.getMonth()+n); state.date.setDate(1); updateDateUI(); loadData(); }
        function setToday() { state.date = new Date(); updateDateUI(); loadData(); }
        function updatePushVal() { document.getElementById('push-val').innerText = document.getElementById('input-push').value; }
        
        // --- MOOD (Select & Keep) ---
        function setMood(v) { 
            document.getElementById('input-mood').value = v; 
            highlightMood(v); 
            saveData(); 
        }
        // Sistemato per non tagliare il glow
        function highlightMood(v) { 
            document.querySelectorAll('.mood-btn').forEach(b => { 
                b.classList.remove('active', 'border-white/40', 'bg-white/20', 'grayscale-0', 'opacity-100'); 
                b.classList.add('opacity-40', 'grayscale', 'border-transparent'); 
            }); 
            if(v > 0) {
                const el = document.getElementById(`m${v}`); 
                if(el){ 
                    el.classList.remove('opacity-40', 'grayscale', 'border-transparent'); 
                    el.classList.add('active', 'border-white/40', 'bg-white/20', 'grayscale-0', 'opacity-100'); 
                }
            }
        }

        // --- KPI & CHARTS ---
        function updateKPIs() {
            const y = state.date.getFullYear(), m = state.date.getMonth();
            const days = new Date(y, m+1, 0).getDate();
            let totCons=0, totInc=0, totPush=0, count=0;
            const totalH = state.habits.length || 1;

            for(let i=1; i<=days; i++) {
                const k = getKey(new Date(y, m, i)); // Usa costruttore locale
                const d = state.data[k];
                if(d) { count++; totCons += (d.checked?.length||0); totInc += parseFloat(d.money)||0; totPush += parseFloat(d.push)||0; }
            }
            document.getElementById('kpi-cons').innerText = count ? Math.round((totCons/(count*totalH))*100)+'%' : '0%';
            document.getElementById('kpi-inc').innerText = totInc.toLocaleString('en-US');
            document.getElementById('kpi-push').innerText = count ? (totPush/count).toFixed(1) : '0.0';
            
            let s=0, cd=new Date();
            while(true) {
                const k = getKey(cd);
                const d = state.data[k];
                if(d && d.checked?.length >= totalH/2) { s++; cd.setDate(cd.getDate()-1); } else break;
            }
            document.getElementById('kpi-streak').innerText = s;
        }

        function updateCharts() {
            const y = state.date.getFullYear(), m = state.date.getMonth();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            
            // Trova l'ultimo giorno che ha dati (il "limite")
            let lastDayWithData = 0;
            for(let i=1; i<=daysInMonth; i++) {
                 const k = getKey(new Date(y, m, i));
                 if(state.data[k]) lastDayWithData = i;
            }
            
            const labels=[], cData=[], mData=[], sData=[], pData=[], moodData=[];
            const totalH = state.habits.length || 1;

            for(let i=1; i<=daysInMonth; i++) {
                labels.push(i);
                
                // Se il giorno √® oltre l'ultimo dato, metti null per interrompere la linea
                if (i > lastDayWithData) {
                    cData.push(null); mData.push(null); sData.push(null); pData.push(null); moodData.push(null);
                    continue;
                }

                const k = getKey(new Date(y, m, i));
                const d = state.data[k];
                
                if(d) {
                    cData.push(Math.round(((d.checked?.length||0)/totalH)*100));
                    mData.push(parseFloat(d.money)||0);
                    sData.push(parseFloat(d.sleep)||0);
                    pData.push(parseFloat(d.push)||0);
                    moodData.push(parseFloat(d.mood)||0);
                } else { 
                    // Buco nei dati (giorno saltato ma precedente all'ultimo) -> 0
                    cData.push(0); mData.push(0); sData.push(0); pData.push(0); moodData.push(0); 
                }
            }

            renderChart('chartCons', labels, cData, '#38BDF8', 'line', true);
            renderChart('chartMoney', labels, mData, '#FBBF24', 'bar', false);
            renderChart('chartSleep', labels, sData, '#2DD4BF', 'line', true);
            renderChart('chartPush', labels, pData, '#34D399', 'line', false, moodData);
        }

        function renderChart(id, labels, data, color, type, fill, data2=null) {
            const ctx = document.getElementById(id).getContext('2d');
            if(state.charts[id]) state.charts[id].destroy();

            let bg = color;
            if(fill && type === 'line') {
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, hexToRgbA(color, 0.5));
                gradient.addColorStop(1, hexToRgbA(color, 0));
                bg = gradient;
            }

            const datasets = [{
                label: 'Value', data: data,
                borderColor: color, backgroundColor: bg,
                borderWidth: 2, pointRadius: 0, hoverRadius: 6, fill: fill, tension: 0.3,
                spanGaps: false // La linea si ferma se c'√® null
            }];

            if(data2) {
                datasets.push({
                    label: 'Mood', data: data2,
                    borderColor: '#FB7185', borderDash: [3,3], borderWidth: 1, pointRadius:0, tension:0.4, yAxisID: 'y1'
                });
            }

            state.charts[id] = new Chart(ctx, {
                type: type,
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display: false}, tooltip: {backgroundColor: '#0A0A0E', borderColor: '#333', borderWidth: 1, titleFont: {family: 'Space Mono'}, bodyFont: {family: 'Space Mono'}} },
                    scales: {
                        x: { grid: {color: 'rgba(255,255,255,0.03)'}, ticks: {color: '#64748B', font:{size:9, family:'Space Mono'}} },
                        y: { beginAtZero: true, grid: {color: 'rgba(255,255,255,0.03)'}, ticks: {color: '#64748B', font:{size:9, family:'Space Mono'}} },
                        y1: { display: !!data2, position: 'right', grid:{display:false} }
                    }
                }
            });
        }
        
        function hexToRgbA(hex, alpha){
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c= '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex;
        }

        init();
    </script>
</body>
</html>
